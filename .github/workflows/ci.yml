name: mini-ccstatus-ci

on:
  push:
    branches:
      - main
      - develop
      - feat/**
      - chore/**
      - fix/**
  pull_request:
    branches:
      - main
      - develop
      - feat/**
      - chore/**
      - fix/**
  workflow_dispatch:

jobs:
  test:
    name: test on debian:lts
    runs-on: ubuntu-latest
    container: debian:stable

    steps:
    - name: checkout code
      uses: actions/checkout@v4

    - name: install dependencies
      shell: sh
      run: |
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y build-essential git make valgrind
        fi
        echo "All dependencies installed successfully"

    - name: build default target
      shell: sh
      run: |
        echo "Building default target..."
        make default
        echo "âœ… Default build completed successfully"

    - name: clean project
      shell: sh
      run: |
        echo "Testing clean target..."
        make clean
        echo "âœ… Clean completed successfully"

    - name: build all targets (release, debug, debug-log)
      shell: sh
      run: |
        echo "Building all targets..."
        make build-all
        echo "âœ… All targets built successfully"
        ls -la bin/

    - name: run demo scenarios
      shell: sh
      run: |
        echo "Running all demo scenarios..."
        make demo-all
        echo "âœ… All demos completed successfully"

    - name: run unit and coverage tests
      shell: sh
      run: |
        echo "Running tests..."
        make test
        echo "âœ… Tests completed successfully"

    - name: run valgrind memory leak tests
      shell: sh
      run: |
        echo "Running valgrind memory leak tests..."
        make valgrind
        echo "âœ… Valgrind tests completed - no memory leaks detected"

    - name: full build cycle (make all)
      shell: sh
      run: |
        echo "Running full build cycle (clean, build-all, demo-all, test, valgrind)..."
        make all
        echo "âœ… Full build cycle completed successfully"

    - name: test summary
      shell: sh
      run: |
        echo "ðŸŽ‰ All checks passed"
        echo "- Build successful"
        echo "- All tests passing"
        echo "- Valgrind memory leak tests passing"
        echo "- Clean target working"
